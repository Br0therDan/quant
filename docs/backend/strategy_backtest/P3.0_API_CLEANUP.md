# P3.0 API μ •λ¦¬ μ™„λ£ λ³΄κ³ μ„

> **μ‘μ„±μΌ**: 2025-01-13 20:00  
> **λ‹¨κ³„**: Phase 3.0 - API μ •λ¦¬  
> **μƒνƒ**: β… μ™„λ£

## π“ μ‘μ—… μ”μ•½

### λ³€κ²½ μ‚¬ν•­

#### 1. Backtests API μ •λ¦¬ (13κ° β†’ 10κ°)

**μ κ±°λ μ—”λ“ν¬μΈνΈ (3κ°):**

1. β **POST `/integrated`** (Line 379)

   - **μ΄μ **: POST `/` + POST `/{id}/execute`μ™€ κΈ°λ¥ μ¤‘λ³µ
   - **λ€μ²΄**: 2λ‹¨κ³„ νΈμ¶ μ‚¬μ© (λ°±ν…μ¤νΈ μƒμ„± β†’ μ‹¤ν–‰)
   - **λ³€κ²½**: μ™„μ „ μ κ±° + μ£Όμ„μΌλ΅ μ΄μ  μ„¤λ…

2. β **GET `/results/duckdb`** (Line 318)

   - **μ΄μ **: DuckDB μ €μ¥ λ―Έκµ¬ν„ (`_save_to_duckdb()` λΉ κµ¬ν„)
   - **λ€μ²΄**: GET `/{id}/executions` μ‚¬μ©
   - **λ³€κ²½**: μ£Όμ„ μ²λ¦¬ (P3.2 DuckDB κµ¬ν„ μ‹ μ¬ν™μ„±ν™”)

3. β **GET `/analytics/summary`** (Line 573)
   - **μ΄μ **: `/analytics/performance-stats`μ™€ κΈ°λ¥ μ¤‘λ³µ
   - **λ€μ²΄**: `/analytics/performance-stats` μ‚¬μ©
   - **λ³€κ²½**: μ™„μ „ μ κ±° + μ£Όμ„μΌλ΅ λ€μ²΄ λ°©λ²• μ„¤λ…

**μ μ§€λ μ—”λ“ν¬μΈνΈ (10κ°):**

```
β… CRUD (5κ°)
POST   /                          # λ°±ν…μ¤νΈ μƒμ„±
GET    /                          # λ°±ν…μ¤νΈ λ©λ΅
GET    /{id}                      # λ°±ν…μ¤νΈ μƒμ„Έ
PUT    /{id}                      # λ°±ν…μ¤νΈ μμ •
DELETE /{id}                      # λ°±ν…μ¤νΈ μ‚­μ 

β… μ‹¤ν–‰ (2κ°)
POST   /{id}/execute              # λ°±ν…μ¤νΈ μ‹¤ν–‰ (Orchestrator)
GET    /{id}/executions           # μ‹¤ν–‰ κΈ°λ΅ μ΅°ν

β… μ ν‹Έλ¦¬ν‹° (3κ°)
GET    /health                    # μ‹μ¤ν… μƒνƒ ν™•μΈ
GET    /analytics/performance-stats # μ„±κ³Ό λ¶„μ„
GET    /analytics/trades          # κ±°λ λ¶„μ„
```

#### 2. Strategies API ν™•μΈ (8κ° β†’ 9κ°)

**μ΄λ―Έ κµ¬ν„λ ν…ν”λ¦Ώ API:**

- β… **GET `/templates`** - ν…ν”λ¦Ώ λ©λ΅ μ΅°ν
- β… **POST `/templates/{id}/clone`** - ν…ν”λ¦Ώ λ³µμ 

**λΌμ°ν„° λ“±λ΅ ν™•μΈ:**

- β… `strategies/__init__.py`μ— μ΄λ―Έ λ“±λ΅λ¨
- β… `/strategies/templates` κ²½λ΅λ΅ μ ‘κ·Ό κ°€λ¥

**μµμΆ… Strategies API (9κ°):**

```
β… CRUD (5κ°)
POST   /                          # μ „λµ μƒμ„±
GET    /                          # μ „λµ λ©λ΅
GET    /{id}                      # μ „λµ μƒμ„Έ
PUT    /{id}                      # μ „λµ μμ •
DELETE /{id}                      # μ „λµ μ‚­μ 

β… μ‹¤ν–‰/μ΅°ν (2κ°)
GET    /{id}/executions           # μ‹¤ν–‰ κΈ°λ΅
GET    /{id}/performance          # μ„±κ³Ό μ΅°ν

β οΈ  μ¬κ²€ν†  (1κ°)
POST   /{id}/execute              # μ „λµ λ‹¨λ… μ‹¤ν–‰ (μ©λ„ λ…ν™•ν™” ν•„μ”)

β… ν…ν”λ¦Ώ (2κ°)
GET    /templates                 # ν…ν”λ¦Ώ λ©λ΅
POST   /templates/{id}/clone      # ν…ν”λ¦Ώ λ³µμ 
```

---

## π“ μ½”λ“ λ³€κ²½ λ‚΄μ—­

### νμΌ: `backend/app/api/routes/backtests.py`

#### 1. Import μ •λ¦¬

```python
# β μ κ±°λ import
# IntegratedBacktestRequest
# IntegratedBacktestResponse
# BacktestConfig (λ―Έμ‚¬μ©)

# β… μ£Όμ„μΌλ΅ μ κ±° μ΄μ  λ…μ‹
from app.schemas.backtest import (
    # ...
    # IntegratedBacktestRequest,  # β Removed in P3.0
    # IntegratedBacktestResponse,  # β Removed in P3.0
)
```

#### 2. `/integrated` μ—”λ“ν¬μΈνΈ μ κ±°

```python
# β REMOVED: /integrated endpoint (P3.0 API cleanup)
# Reason: Duplicate functionality with POST / + POST /{id}/execute
# Use two-step process: 1) Create backtest, 2) Execute backtest
# For convenience, frontend can chain these calls
```

#### 3. `/results/duckdb` μ—”λ“ν¬μΈνΈ μ£Όμ„ μ²λ¦¬

```python
# β DEPRECATED: /results/duckdb endpoint (P3.0 API cleanup)
# Reason: DuckDB storage not implemented yet (_save_to_duckdb is empty)
# Currently returns MongoDB data, which is misleading
# TODO: Re-enable when DuckDB storage is implemented in P3.2
# For now, use GET /{id}/executions for execution results
```

#### 4. `/analytics/summary` μ—”λ“ν¬μΈνΈ μ κ±°

```python
# β REMOVED: /analytics/summary endpoint (P3.0 API cleanup)
# Reason: Duplicate functionality with /analytics/performance-stats
# Use /analytics/performance-stats instead for performance metrics
# Or use GET /{id}/executions for detailed execution data
```

---

## β… κ²€μ¦ κ²°κ³Ό

### 1. λ¦°νΈ κ²€μ‚¬

```bash
cd backend && uv run ruff check app/api/routes/backtests.py
# β… All checks passed!
```

### 2. μ—”λ“ν¬μΈνΈ μΉ΄μ΄νΈ

**Before (P3.0 μ΄μ „):**

- Backtests: 13κ°
- Strategies: 8κ° (ν…ν”λ¦Ώ λ―Έν™•μΈ)

**After (P3.0 μ™„λ£):**

- Backtests: 10κ° (3κ° μ κ±°)
- Strategies: 9κ° (ν…ν”λ¦Ώ ν™•μΈλ¨)

### 3. μ£Όμ„ μ²λ¦¬ vs μ™„μ „ μ κ±°

| μ—”λ“ν¬μΈνΈ           | μ²λ¦¬ λ°©μ‹ | μ΄μ                         |
| -------------------- | --------- | --------------------------- |
| `/integrated`        | μ™„μ „ μ κ±° | λ€μ²΄ λ°©λ²• λ…ν™• (2λ‹¨κ³„ νΈμ¶) |
| `/results/duckdb`    | μ£Όμ„ μ²λ¦¬ | P3.2μ—μ„ DuckDB κµ¬ν„ μμ •   |
| `/analytics/summary` | μ™„μ „ μ κ±° | λ‹¤λ¥Έ μ—”λ“ν¬μΈνΈλ΅ λ€μ²΄ κ°€λ¥ |

---

## π― ν”„λ΅ νΈμ—”λ“ μν–¥ λ¶„μ„

### Breaking Changes

#### 1. `/integrated` μ κ±°

**κΈ°μ΅΄ μ½”λ“:**

```typescript
// β λ” μ΄μƒ λ™μ‘ν•μ§€ μ•μ
const result = await BacktestService.createAndRunIntegrated({
  name: "My Backtest",
  // ...
});
```

**λ³€κ²½ ν•„μ”:**

```typescript
// β… μƒλ΅μ΄ λ°©μ‹ (2λ‹¨κ³„)
// 1λ‹¨κ³„: λ°±ν…μ¤νΈ μƒμ„±
const backtest = await BacktestService.createBacktest({
  name: "My Backtest",
  // ...
});

// 2λ‹¨κ³„: λ°±ν…μ¤νΈ μ‹¤ν–‰
const execution = await BacktestService.executeBacktest({
  backtest_id: backtest.id,
});
```

#### 2. `/results/duckdb` μ κ±°

**κΈ°μ΅΄ μ½”λ“:**

```typescript
// β λ” μ΄μƒ λ™μ‘ν•μ§€ μ•μ
const results = await BacktestService.getResultsFromDuckdb({
  backtest_id: id,
});
```

**λ³€κ²½ ν•„μ”:**

```typescript
// β… μƒλ΅μ΄ λ°©μ‹
const executions = await BacktestService.getBacktestExecutions({
  backtest_id: id,
});
```

#### 3. `/analytics/summary` μ κ±°

**κΈ°μ΅΄ μ½”λ“:**

```typescript
// β λ” μ΄μƒ λ™μ‘ν•μ§€ μ•μ
const summary = await BacktestService.getSummaryAnalytics();
```

**λ³€κ²½ ν•„μ”:**

```typescript
// β… μƒλ΅μ΄ λ°©μ‹
const stats = await BacktestService.getPerformanceStats();
```

---

## π“ λ‹¤μ λ‹¨κ³„

### P3.1 ν†µν•© ν…μ¤νΈ (μ§„ν–‰ μ¤‘)

- [x] BacktestOrchestrator ν…μ¤νΈ (μ™„λ£)
- [x] StrategyExecutor ν…μ¤νΈ (μ™„λ£)
- [ ] DataProcessor ν…μ¤νΈ ν™•μ¥
- [ ] E2E ν…μ¤νΈ μ‘μ„±
- [ ] ν…μ¤νΈ μ ν‹Έλ¦¬ν‹° μ‘μ„±

### P3.2 μ„±λ¥ μµμ ν™”

- [ ] **DuckDB μ €μ¥ κµ¬ν„** (μ°μ„ μμ„ λ†’μ)
  - `_save_to_duckdb()` λ©”μ„λ“ κµ¬ν„
  - `/results/duckdb` μ—”λ“ν¬μΈνΈ μ¬ν™μ„±ν™”
- [ ] **λ³‘λ ¬ λ°μ΄ν„° μμ§‘**
  - `_collect_market_data()` asyncio.gather μ μ©
- [ ] μΊμ‹± μ „λµ κ°μ„ 
- [ ] λ°°μΉ μ²λ¦¬

### P3.3 μ—λ¬ μ²λ¦¬ κ°•ν™”

- [ ] μ¬μ‹λ„ λ΅μ§ (tenacity)
- [ ] μƒμ„Έν• μ—λ¬ λ©”μ‹μ§€
- [ ] Circuit breaker ν¨ν„΄

### P3.4 λ¨λ‹ν„°λ§ κ°μ„ 

- [ ] κµ¬μ΅°ν™”λ λ΅κΉ… (structlog)
- [ ] λ©”νΈλ¦­ μμ§‘ (Prometheus)

---

## π“ P3.0 μ™„λ£ ν†µκ³„

**μ‘μ—… μ‹κ°„**: 1μ‹κ°„  
**λ³€κ²½ νμΌ**: 1κ° (`backtests.py`)  
**μ κ±° λΌμΈ**: ~100 lines  
**μ¶”κ°€ μ£Όμ„**: ~50 lines  
**Breaking Changes**: 3κ° (ν”„λ΅ νΈμ—”λ“ μμ • ν•„μ”)

**κ°μ„  μ§€ν‘**:

- β… API μ—”λ“ν¬μΈνΈ 23% κ°μ† (13 β†’ 10)
- β… μ¤‘λ³µ κΈ°λ¥ μ κ±°λ΅ μ μ§€λ³΄μμ„± ν–¥μƒ
- β… RESTful μ›μΉ™ μ¤€μ κ°μ„ 
- β… λ…ν™•ν• μ£Όμ„μΌλ΅ ν–¥ν›„ μ¬ν™μ„±ν™” μ©μ΄

---

**κ²°λ΅ **: P3.0 API μ •λ¦¬ μ™„λ£ β…  
**λ‹¤μ**: P3.1 ν…μ¤νΈ μ™„μ„± λλ” P3.2 μ„±λ¥ μµμ ν™” μ§„ν–‰ π€
