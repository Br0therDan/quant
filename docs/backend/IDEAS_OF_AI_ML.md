# 백엔드를 위한 AI, ML, 그리고 생성형 AI 기회

## 1. 맥락 요약

- **아키텍처 적합성**: FastAPI 백엔드는 `ServiceFactory`를 통해 도메인
  서비스(시장 데이터, 전략, 백테스트, 관심 목록, 대시보드)를 오케스트레이션하며,
  공용 AI 유틸리티를 등록하고 과도한 결합을 피하기 위한 명확한 지점을
  제공합니다.
- **데이터 스택**: DuckDB는 고성능 분석 캐시로 동작하고, MongoDB는 메타데이터를
  저장하며, Alpha Vantage는 외부 시장 데이터를 공급하여 모델 학습과 추론에
  풍부한 다중 해상도 데이터셋을 제공합니다.
- **기존 분석 훅**: `BacktestService`, `MarketDataService`, `DashboardService`는
  이미 KPI를 계산하고 있어 라우팅 레이어를 재설계하지 않고도 AI 기반 인사이트를
  확장하기 좋은 통합 지점입니다.

## 2. 예측 및 포캐스팅 고도화

### 2.1 ML 기반 시그널 생성

- **목표**: 기존 규칙 기반 전략을 보완하는 확률적 매수·매도 시그널을 생성합니다.
- **통합 지점**:
  - `MarketDataService.stock`을 확장해 DuckDB에서 피처 엔지니어링된 패널을
    노출합니다.
  - `ServiceFactory`를 통해 `MLSignalService`를 주입하고, LightGBM·CatBoost 등의
    모델을 로드하여 `BacktestService`나 전략 엔드포인트가 요청한 심볼을
    스코어링합니다.
- **구현 개요**:
  1. DuckDB 윈도 함수로 롤링 지표를 계산하는 피처 파이프라인을 구축합니다.
  2. 과거 Alpha Vantage 데이터를 활용해 그래디언트 부스팅 분류기(레이블 = 다음
     기간 수익률 부호)를 학습합니다.
  3. 학습된 모델을 `mlflow` 또는 `joblib`으로 저장하고, 신규 서비스에서 지연
     로드하여 기존 지표 데이터와 함께 확률 점수를 반환합니다.
- **효과**: 데이터 기반 진입 시그널을 통해 백테스트 현실성을 높이고, 대시보드
  등에 모델 신뢰도를 전달할 수 있습니다.

### 2.2 시장 국면 및 변동성 분류

- **목표**: 시장 국면(강세, 약세, 횡보, 고변동)을 감지해 전략 파라미터를
  조정합니다.
- **통합 지점**:
  - DuckDB 캐시 갱신 작업에서 국면 라벨을 계산하고 MongoDB에 저장해 빠르게
    조회합니다.
  - `DashboardService`로 국면 메타데이터를 제공하여 성능 지표에 문맥을
    부여합니다.
- **구현 개요**:
  1. 다자산 수익률에 대해 은닉 마코프 모델, 가우시안 혼합, PCA 기반 k-means 같은
     군집 알고리즘을 학습합니다.
  2. `/market-data/regime` 라우트를 통해 최신 추론 국면을 서비스하여 전략이
     파라미터 세트를 전환할 수 있게 합니다.
- **효과**: 국면 전환 감지 시 적응형 전략과 리스크 관리 알림을 가능하게 합니다.

### 2.3 포트폴리오 KPI 확률 예측

- **목표**: 단기 포트폴리오 가치 분포와 드로다운 위험을 예측합니다.
- **통합 지점**:
  - `PortfolioService.get_portfolio_performance`를 확장해 `ServiceFactory`에
    등록된 `InferenceEngine`에서 확률 예측을 요청합니다.
  - 대시보드 응답에 5/95 퍼센타일과 같은 예측 구간을 노출합니다.
- **구현 개요**:
  1. Prophet, Temporal Fusion Transformer, GluonTS 등 시계열 모델을 사용해
     집계된 포트폴리오 에쿼티 커브를 학습합니다.
  2. 사후 분포의 분위수를 DuckDB에 저장하여 역사적 평가에 활용합니다.
  3. 팬 차트와 VaR 스타일 위험 지표를 반환하는 추론 엔드포인트를 제공합니다.
- **효과**: 이용자에게 단일 추정값을 넘어 시나리오 인식과 신뢰 구간을
  제공합니다.

## 3. 지능형 자동화 및 최적화

### 3.1 전략 파라미터 자동 튜닝

- **목표**: 수동 그리드 서치를 베이지안 최적화나 진화적 튜닝으로 대체합니다.
- **통합 지점**:
  - `/backtests/optimize` 엔드포인트에서 Optuna 스터디 등을 호출해
    `BacktestService` 실행을 최적화 루프에 감쌉니다.
  - 실험 메타데이터와 최적 파라미터를 MongoDB에 저장해 재현성을 확보합니다.
- **구현 개요**:
  1. 후보 파라미터로 `BacktestService.run_backtest`를 호출하는 목적 함수를
     정의합니다.
  2. Optuna/Hyperopt로 파라미터 공간을 탐색하고 Celery나 FastAPI 백그라운드 작업
     등 비동기 잡 러너로 병렬화합니다.
  3. 결과 리더보드를 `DashboardService`에 제공하여 시각화합니다.
- **효과**: 신규 전략의 가치 실현 시간을 단축하고, 파라미터 세트가 최신 시장
  국면에 맞게 유지됩니다.

### 3.2 강화학습 기반 전략 실행

- **목표**: 포지션 사이징과 행동 타이밍을 학습하는 RL 기반 트레이딩 정책을
  도입합니다.
- **통합 지점**:
  - `TradingSimulator`를 확장해 RL 학습 루프용 OpenAI Gym 스타일의 step/reset
    인터페이스를 노출합니다.
  - 사용자가 옵트인할 경우 `IntegratedBacktestExecutor`에서 호출할 수 있는
    `RLEngine`을 제공합니다.
- **구현 개요**:
  1. `MarketDataService`의 가격, 기술 지표, 국면 라벨을 활용해 상태 표현을
     정의합니다.
  2. Stable-Baselines3나 Ray RLlib과 같은 라이브러리로 정책을 학습하고
     체크포인트를 객체 저장소에 보관합니다.
  3. 감사 가능성을 위해 결정론적 정책 롤아웃으로 백테스트 내 평가를 수행하도록
     합니다.
- **효과**: 다단계 보상 구조와 거래 비용에 반응하는 적응형 전략을 구현합니다.

### 3.3 데이터 품질 및 이상 탐지 파이프라인

- **목표**: 백테스트를 오염시키기 전에 의심스러운 데이터 포인트를 자동으로
  표시합니다.
- **통합 지점**:
  - `MarketDataService`의 데이터 수집 루틴에 Isolation Forest, Prophet 이상치
    점수 등 온라인 이상 탐지를 연동합니다.
  - 이상 플래그를 MongoDB에 저장하고 `Pipeline` 또는 `Dashboard` API를 통해
    노출합니다.
- **구현 개요**:
  1. 점프, 결측 구간, 거래량 급증에 집중하여 과거 심볼 패널로 이상 탐지 모델을
     학습합니다.
  2. DuckDB 캐시 기록 중 스트리밍 검사를 실행하고, 플래그된 행을 격리해 수동
     검토를 지원합니다.
  3. 관리자 대시보드에서 이상 발생 건수와 심각도를 제공합니다.
- **효과**: 데이터셋 무결성을 유지하고 다운스트림 ML 모델이 드리프트에 영향을
  받지 않도록 보호합니다.

## 4. 생성형 AI 활용

### 4.1 전략 인사이트 내러티브

- **목표**: 백테스트 결과와 국면 맥락을 사람이 읽기 쉬운 요약으로 생성합니다.
- **통합 지점**:
  - `BacktestService`가 지표를 산출한 뒤 LLM(OpenAI, Azure, 로컬 Llama 등)에
    DuckDB KPI를 전달하는 `ReportGenerationService`를 호출합니다.
  - 생성된 내러티브를 `BacktestResult` ID와 연결해 MongoDB에 캐시합니다.
- **구현 개요**:
  1. 수익률, 샤프, 드로다운 등 지표와 국면·시그널 메타데이터를 결합한 구조화된
     프롬프트를 정의합니다.
  2. 사실 일관성을 보장하기 위해 Pydantic 출력 검증기 등 가드레일을 구현합니다.
  3. `/backtests/{id}/report`로 요약을 제공하고 대시보드 위젯에 임베딩합니다.
- **효과**: 수동 분석 없이도 즉시 임원 보고용 요약을 제공합니다.

### 4.2 대화형 전략 빌더

- **목표**: 사용자가 자연어로 원하는 전략을 설명하면 파라미터화된 템플릿으로
  변환합니다.
- **통합 지점**:
  - `/strategies/generative-builder` 라우트를 생성해 LLM이 의도를 `strategies/`
    디렉터리의 기존 전략 클래스와 기본 파라미터로 매핑하도록 합니다.
  - 저장 전 Pydantic 스키마로 생성된 구성을 검증합니다.
- **구현 개요**:
  1. 사용 가능한 지표, 제약, 예시 매핑을 설명하는 프롬프트 라이브러리를
     구축합니다.
  2. `text-embedding-3-large`, `sentence-transformers`와 같은 임베딩으로 사용자
     의도를 문서화된 전략 역량에 정렬합니다.
  3. `StrategyService`가 신규 전략 레코드로 변환할 수 있는 구조화된 JSON 출력을
     생성합니다.
- **효과**: 온보딩 장벽을 낮추고 고급 전략 접근성을 민주화합니다.

### 4.3 운영 및 진단용 ChatOps

- **목표**: 캐시 상태, 데이터 최신성, Alpha Vantage 상태를 모니터링하는 대화형
  에이전트를 제공합니다.
- **통합 지점**:
  - `MarketDataService.health_check`와 `DatabaseManager`의 상태 지표를 도구 기반
    접근 권한이 있는 LLM 에이전트에 공개합니다.
  - FastAPI 라우트 또는 Slack 봇으로 배포해 운영 관련 질문에 답변하도록 합니다.
- **구현 개요**:
  1. `get_cache_status`, `list_recent_failures` 등 기존 서비스를 호출하는 도구
     함수를 등록합니다.
  2. 함수 호출 기능이 있는 모델이 질문을 해석하고 적절한 도구를 실행하도록
     합니다.
  3. 민감한 명령 실행을 방지하기 위해 RBAC 검사를 구현합니다.
- **효과**: 사고 대응 속도를 높이고 비엔지니어에게도 통합 지원 인터페이스를
  제공합니다.

## 5. 플랫폼 기반 요소

| 역량                          | 설명                                                                    | 제안 단계                                                                                                                 |
| ----------------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| **피처 스토어**               | DuckDB에 엔지니어링된 피처를 중앙화하여 ML 모델 간 재사용을 촉진합니다. | OHLCV 집계, 팩터 익스포저 등 표준화된 뷰를 정의하고 버전 관리합니다.                                                      |
| **모델 라이프사이클 관리**    | 실험 추적, 모델 배포, 드리프트 모니터링을 수행합니다.                   | `mlflow` 또는 `Weights & Biases`를 통합하고, 메타데이터를 MongoDB에 저장하며, 재학습 일정을 자동화합니다.                 |
| **평가 하네스**               | AI 구성 요소가 리스크 및 컴플라이언스 요구를 충족하는지 검증합니다.     | 과거 기간을 재생하는 벤치마크 모음을 만들고, 기준 전략과 비교하며, SHAP 값이나 반사례 등 설명 가능성 산출물을 기록합니다. |
| **프롬프트 및 정책 거버넌스** | 생성형 AI 프롬프트와 가드레일을 체계적으로 관리합니다.                  | 버전 관리되는 템플릿에 프롬프트를 저장하고, 응답을 저장하거나 사용자에게 보여주기 전에 독성·팩트 체킹을 추가합니다.       |

## 6. 다음 단계

1. 기존 데이터 파이프라인을 재활용할 수 있는 빠른 성공(시그널 생성, 리포트
   내러티브)부터 우선순위를 정합니다.
2. 의존성을 일관되게 관리하도록 `ServiceFactory`에 공용 AI 서비스를 설계합니다.
3. RL이나 대화형 에이전트를 도입하기 전에 실험 추적과 피처 스토어 같은 MLOps
   토대를 마련합니다.
4. 단일 자산 유니버스로 아이디어를 시험하고 평가 지표를 모은 뒤 Alpha Vantage
   전체 커버리지로 확장합니다.
